<div class="row">
  <div class="col-12 col-sm-8">
    <div class="clearfix widget">
      <h3 class="with-pill-nav">Hotline Activity</h3>
      <ul class="nav nav-pills">
        <li class="nav-item"><%= link_to 'All', "#", :class => 'all-activities-link nav-link active' %></li>
        <li class="nav-item"><%= link_to 'Mine', "#", :class => 'my-activities-link nav-link' %></li>
      </ul>
      <%= form_for(Activity.new, :remote => true) do |f| %>
        <%= f.text_area :body, :class => 'activity-update form-control', :placeholder => 'Talk with the other hotline operators...' %>
        <%= f.submit 'Share', :class => 'btn btn-primary float-end' %>
      <% end %>
    </div>

    <div id="activities">
      <%= render @activites %>
    </div>
  </div>
  <div class="col-12 col-sm-4">
    <div class="card mb-4">
      <div class="card-header">Operators</div>
      <div class="card-body">
        <div id="operators">
          <%= render 'users/operators_grid' %>
        </div>
      </div>
      <div class="card-footer text-center">
        <!-- TODO: Looks like crap on small displays. Un-group? -->
        <div class="btn-group" role="group" aria-label="Operator List Options">
          <%= link_to 'On Call', "#", :class => "on-call-operators-listing btn btn-primary" %>
          <%= link_to 'All', "#", :class => "all-operators-listing btn btn-outline-primary" %>
          <%= link_to 'Invite', new_user_path, "data-bs-toggle" => 'modal', 'data-bs-target' => '#invite-modal', "data-bs-backdrop" => "static", :class => 'btn btn-outline-primary' if admin? %>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">My Schedule</div>
      <div class="card-body">
        <!-- TODO: Horizontal on xs, standard on sm/md, Horizontal on lg -->
        <ul class="list-group list-group-horizontal-lg">
          <% schedules = current_user.oncall_schedules %>
          <% (0..4).each do |i| %>
            <% day = i.days.from_now%>
            <% schedule = schedules.select{|s| s.wday == day.to_date.cwday}.first %>
            <li title="<%= "<strong>#{schedule.nil? ? 'Not Scheduled' : schedule.to_abbrev}</strong><br />#{day.strftime("%A")}" %>s" class="flex-fill list-group-item schedule-day <%= 'list-group-item-success' if schedule.present? %>">
              <div class="month"><%= day.strftime("%b")%></div>
              <div class="day"><%= day.strftime("%e")%></div>
            </li>
          <% end %>
        </ul>
      </div>
      <div class="card-footer">
        <%= link_to 'Edit', user_oncall_schedules_path(:current) %>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">Recent Calls</div>
      <div class="card-body">
        <% current_user.calls.limit(3).each do |call| %>
          <div class="recent-call">
            <a class="call-date" href="#<%# url_for(call) %>">
              <div class="month"><%= call.created_at.strftime("%b")%></div>
              <div class="day"><%= call.created_at.strftime("%e")%></div>
            </a>
            <div class="call-content">
              <div class="call-row">
                <span class="call-name">Call #<%= call.id %> <small><%= call.timecode %></small></span>
              </div>
              <div class="call-row">
              </div>
              <div class="call-row call-timestamp">
                <%= call.created_at.strftime("%l:%M %p %Z") %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      <div class="card-footer"><%= link_to 'View All', current_user.admin? ? calls_path : user_calls_path(:current) %></div>
    </div>

  </div>
</div>
<script>
  $(function() {
    $('textarea').not('.no-auto-resize').autoResize({extraSpace:0, animate:false});
    $("abbr.timeago").timeago();
    $('.operator').twipsy({html: true});

    $('textarea.comment').live( 'keypress', function(e){
      if (e.keyCode == 13) { // enter key was pressed
        if (e.shiftKey) { // shift key is down
          // don't submit
        } else {
          // submit
          e.preventDefault();
          $(this).parents('form').submit();
        }
      }
    });
  });
</script>


<script>
  $(".my-activities-link").click(function() {
    $('#activites').html(''); makeActiveTab($(this)); $.get('<%= user_activities_url(:current, :format => :js) %>');
  })
</script>
<script>
    $(".all-activities-link").click(function() {
      $('#activites').html(''); makeActiveTab($(this)); $.get('<%= activities_url(:format => :js) %>');
    });
</script>
<script>
  $(".on-call-operators-listing").click(function() {
    $(this).parents(".btn-group").find(".btn-primary").removeClass("btn-primary active").addClass("btn-outline-primary");
    $(this).addClass("btn-primary").removeClass("btn-outline-primary");
    $('#oncall-operators').show();
    $('#all-operators').hide();
  });
  $(".all-operators-listing").click(function() {
    $(this).parents(".btn-group").find(".btn-primary").removeClass("btn-primary active").addClass("btn-outline-primary");
    $(this).addClass("btn-primary").removeClass("btn-outline-primary");
    $('#oncall-operators').hide();
    $('#all-operators').show();
  });
</script>

<% if admin? %>
  <%= render 'users/invite_modal' %>
<% end %>